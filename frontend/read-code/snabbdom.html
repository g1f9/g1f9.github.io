<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>snabbdom 解析 | g1f9</title>
    <meta name="description" content="记录">
    
    
    <link rel="preload" href="/assets/css/0.styles.74efe9eb.css" as="style"><link rel="preload" href="/assets/js/app.ccbd119b.js" as="script"><link rel="preload" href="/assets/js/2.7f0dc0b6.js" as="script"><link rel="preload" href="/assets/js/18.11f598b4.js" as="script"><link rel="prefetch" href="/assets/js/10.0efb1b32.js"><link rel="prefetch" href="/assets/js/11.c90cd893.js"><link rel="prefetch" href="/assets/js/12.972c5b8f.js"><link rel="prefetch" href="/assets/js/13.2badb955.js"><link rel="prefetch" href="/assets/js/14.b0df3f85.js"><link rel="prefetch" href="/assets/js/15.5d827cb8.js"><link rel="prefetch" href="/assets/js/16.c6f4a891.js"><link rel="prefetch" href="/assets/js/17.27916a81.js"><link rel="prefetch" href="/assets/js/19.73dae33a.js"><link rel="prefetch" href="/assets/js/20.15c25eec.js"><link rel="prefetch" href="/assets/js/21.a870acbb.js"><link rel="prefetch" href="/assets/js/22.ca308be0.js"><link rel="prefetch" href="/assets/js/23.a3e9e8f8.js"><link rel="prefetch" href="/assets/js/24.b6bb07e2.js"><link rel="prefetch" href="/assets/js/25.0359653c.js"><link rel="prefetch" href="/assets/js/26.a09d11a6.js"><link rel="prefetch" href="/assets/js/27.9a34aab8.js"><link rel="prefetch" href="/assets/js/28.1262566c.js"><link rel="prefetch" href="/assets/js/29.3eb81e77.js"><link rel="prefetch" href="/assets/js/3.d46bcc0e.js"><link rel="prefetch" href="/assets/js/30.faa6dd9c.js"><link rel="prefetch" href="/assets/js/31.3b40da97.js"><link rel="prefetch" href="/assets/js/32.eec2213b.js"><link rel="prefetch" href="/assets/js/33.14287cf7.js"><link rel="prefetch" href="/assets/js/4.570df549.js"><link rel="prefetch" href="/assets/js/5.482ae8ae.js"><link rel="prefetch" href="/assets/js/6.32b63521.js"><link rel="prefetch" href="/assets/js/7.5ad4d5a2.js"><link rel="prefetch" href="/assets/js/8.890852ad.js"><link rel="prefetch" href="/assets/js/9.4be23048.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74efe9eb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">g1f9</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/resource.html" class="nav-link">资源收集</a></li><li class="dropdown-item"><!----> <a href="/frontend/basics/" class="nav-link">基础阅读</a></li><li class="dropdown-item"><!----> <a href="/frontend/read-code/" class="nav-link router-link-active">源码阅读</a></li><li class="dropdown-item"><!----> <a href="/frontend/advanced/" class="nav-link">扩展阅读</a></li><li class="dropdown-item"><!----> <a href="/frontend/note/" class="nav-link">笔记</a></li><li class="dropdown-item"><!----> <a href="/frontend/source/" class="nav-link">资源收集</a></li></ul></div></div><div class="nav-item"><a href="/tools/" class="nav-link">工具</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/resource.html" class="nav-link">资源收集</a></li><li class="dropdown-item"><!----> <a href="/frontend/basics/" class="nav-link">基础阅读</a></li><li class="dropdown-item"><!----> <a href="/frontend/read-code/" class="nav-link router-link-active">源码阅读</a></li><li class="dropdown-item"><!----> <a href="/frontend/advanced/" class="nav-link">扩展阅读</a></li><li class="dropdown-item"><!----> <a href="/frontend/note/" class="nav-link">笔记</a></li><li class="dropdown-item"><!----> <a href="/frontend/source/" class="nav-link">资源收集</a></li></ul></div></div><div class="nav-item"><a href="/tools/" class="nav-link">工具</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>snabbdom 解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontend/read-code/snabbdom.html#virtual-dom" class="sidebar-link">Virtual DOM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontend/read-code/snabbdom.html#virtual-dom-简介" class="sidebar-link">Virtual DOM 简介</a></li><li class="sidebar-sub-header"><a href="/frontend/read-code/snabbdom.html#virtual-dom-节点格式" class="sidebar-link">Virtual DOM 节点格式</a></li><li class="sidebar-sub-header"><a href="/frontend/read-code/snabbdom.html#生成一个虚拟节点" class="sidebar-link">生成一个虚拟节点</a></li><li class="sidebar-sub-header"><a href="/frontend/read-code/snabbdom.html#树的遍历" class="sidebar-link">树的遍历</a></li></ul></li><li><a href="/frontend/read-code/snabbdom.html#snaddom-实现" class="sidebar-link">Snaddom 实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontend/read-code/snabbdom.html#解析" class="sidebar-link">解析</a></li><li class="sidebar-sub-header"><a href="/frontend/read-code/snabbdom.html#init-方法-2" class="sidebar-link">Init 方法</a></li><li class="sidebar-sub-header"><a href="/frontend/read-code/snabbdom.html#patchvnode-方法" class="sidebar-link">patchVnode 方法</a></li><li class="sidebar-sub-header"><a href="/frontend/read-code/snabbdom.html#patchchildren" class="sidebar-link">patchChildren</a></li><li class="sidebar-sub-header"><a href="/frontend/read-code/snabbdom.html#总结" class="sidebar-link">总结</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="snabbdom-解析"><a href="#snabbdom-解析" aria-hidden="true" class="header-anchor">#</a> snabbdom 解析</h1> <blockquote><p>分析 Snabbdom 的源码构成，理清虚拟 DOM 的编写和应用思路，相对于 Vue 等虚拟 dom 源码，Snabbdom 的目的更单一，也更加容易阅读。</p></blockquote> <h2 id="virtual-dom"><a href="#virtual-dom" aria-hidden="true" class="header-anchor">#</a> Virtual DOM</h2> <h3 id="virtual-dom-简介"><a href="#virtual-dom-简介" aria-hidden="true" class="header-anchor">#</a> Virtual DOM 简介</h3> <p>Virtual DOM 是一个能够直接描述一段 HTML DOM 结构的 JavaScript 对象，我们可以直接根据 Virtual DOM 描述的结构渲染创建出唯一确定的 HTML DOM 结构。从整体上看，Virtual DOM 的交互模式减少了 MVVM 或其他框架对 DOM 的扫描或操作次数，并且在数据发生改变后只在合适的地方根据 JavaScript 对象来进行最小化的页面 DOM 操作。Virtual DOM 在 DOM 的操作上有一定的优化，体现在 DOM 操作的优化上。如果仅仅只是 DOM 操作优化并体现不了 Virtual DOM 的价值，毕竟我们也可以通其他方式来优化 DOM 操作，并且 Diff 也需要一定的性能开销。Virtual DOM 真正的价值体现在</p> <ol><li>Virtual DOM 为函数式的 UI 编程方式打开了大门</li> <li>Virtual DOM 可以渲染在 DOM 以外的 backend，也就是渲染到不同端，如移动端，小程序端等。</li></ol> <h3 id="virtual-dom-节点格式"><a href="#virtual-dom-节点格式" aria-hidden="true" class="header-anchor">#</a> Virtual DOM 节点格式</h3> <p>虚拟 DOM 树就是一个 JavaScript 对象，它是由许多个格式相同的树节点组成，理清虚拟节点的组成格式，对于理解虚拟 DOM 树有很大的帮助</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">IVNode</span><span class="token punctuation">{</span>
  sel<span class="token punctuation">:</span><span class="token builtin">string</span> <span class="token operator">|</span> undefined
  data<span class="token punctuation">:</span> IVNodeData <span class="token operator">|</span> undefined
  children<span class="token punctuation">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>IVNode<span class="token operator">&gt;</span> <span class="token operator">|</span> undefined
  elm<span class="token punctuation">:</span> Node <span class="token operator">|</span> undefined
  text<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> undefined
  key<span class="token punctuation">:</span> Key <span class="token operator">|</span> undefined
<span class="token punctuation">}</span>
</code></pre></div><ol><li>sel 是一个 CSS 选择器，在创建实际 DOM 节点的时候会用到。如 div,div.cls,div#id</li> <li>data 字段存储各种各种信息如，css 的 class，style，hook 生命周期钩子等，主要用于在创建真正的 DOM 元素的时候，提供给模块使用，用来装饰 DOM 节点</li> <li>children 就是子节点，是一个数组</li> <li>elm 是一个指向真正 DOM 元素的指针</li> <li>text 是一个字符串，是一个文本节点</li> <li>key 是用标示一个虚拟 DOM 的标识符，key 的真正用途在于告诉 Virtual DOM 数据变化时去复用 DOM 元素。比如一个数组 a1 渲染成一组 DOM 列表，我们在之后的使用 API 又请求了一批数据 a2，那么 a1!==a2,但是 a1 可能和 a2 只是一些简单的内容不一致，我们希望复用 DOM 元素，那么就可以使用 key，只要 a1.item.key === a2.item.key 那么就会复用 DOM 元素。在如何判断两个节点是否为相同的节点时，就是用 v1.sel===v2.sel&amp;&amp;v1.key === v2.key</li></ol> <h3 id="生成一个虚拟节点"><a href="#生成一个虚拟节点" aria-hidden="true" class="header-anchor">#</a> 生成一个虚拟节点</h3> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token parameter">sel<span class="token punctuation">:</span><span class="token builtin">string</span><span class="token punctuation">,</span>data<span class="token punctuation">:</span><span class="token builtin">any</span><span class="token punctuation">,</span>children<span class="token punctuation">:</span>IVNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>text<span class="token punctuation">:</span><span class="token builtin">string</span><span class="token operator">|</span>undefined<span class="token punctuation">,</span>elm<span class="token punctuation">:</span>Element<span class="token operator">|</span>Text</span><span class="token punctuation">)</span><span class="token punctuation">:</span>IVNode<span class="token punctuation">{</span>
  <span class="token comment">// Element 是普通节点，Text 是文本节点</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> data<span class="token operator">&amp;&amp;</span>data<span class="token punctuation">.</span>key
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    sel<span class="token punctuation">,</span>
    data<span class="token punctuation">,</span>
    children<span class="token punctuation">,</span>
    elm<span class="token punctuation">,</span>
    text<span class="token punctuation">,</span>
    key
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>生成一个虚拟节点，即是把所有传入的属性包在一个对象内即可</p> <h3 id="树的遍历"><a href="#树的遍历" aria-hidden="true" class="header-anchor">#</a> 树的遍历</h3> <p>在虚拟 DOM 树的创建和更新，都会递归地去查找各个节点，并且决定是否更新节点，在 Snabbdom 中常用的是深度遍历的方式，大致的格式如下</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">traverseTree</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'begin'</span><span class="token punctuation">,</span>node<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token keyword">const</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>children
  <span class="token keyword">if</span><span class="token punctuation">(</span>child<span class="token operator">&amp;&amp;</span><span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>item <span class="token keyword">of</span> child<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">traverseTree</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">,</span>node<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span>children</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">,</span>
    children
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> v1 <span class="token operator">=</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> v2 <span class="token operator">=</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> v3 <span class="token operator">=</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">[</span>v1<span class="token punctuation">,</span>v2<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> v4 <span class="token operator">=</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> v5 <span class="token operator">=</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token punctuation">[</span>v4<span class="token punctuation">,</span>v3<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token function">iterateTree</span><span class="token punctuation">(</span>v5<span class="token punctuation">)</span>
</code></pre></div><p>由于在创建和更新的时候也是采用了上面的遍历步骤，因此总是会先创建子节点，调用子节点的钩子，然后再创建当前节点</p> <h2 id="snaddom-实现"><a href="#snaddom-实现" aria-hidden="true" class="header-anchor">#</a> Snaddom 实现</h2> <p>要实现一个虚拟 DOM 的库，大概要以下几个步骤</p> <ol><li>定义虚拟节点的格式</li> <li>实现 createElement 方法，用于将虚拟DOM 树，转换成真正的节点，其大概的实现方式也就是递归遍历虚拟 DOM 树，然后根据配置递归创建 DOM 树。</li> <li>实现 patchNode 方法，用于对比两个虚拟 DOM 树，并对其 DOM 进行更新。然后判断子节点的差异，调用 patchChildren 去对比和更新子节点</li> <li>实现 patchChidren 方法，用于比较虚拟 DOM 的子节点之间的差异，并对其进行更新。因为 children 是一个数组，会出现数组顺序改变，数组节点新增等情况，为了优化子节点之间的更新，需要实现一个独立的算法，用来优化子节更新。</li> <li>最后实现 patch 方法，用来处理各种传入的参数的差异。只是一些简单的判断逻辑。</li></ol> <h3 id="解析"><a href="#解析" aria-hidden="true" class="header-anchor">#</a> 解析</h3> <p>从官网上的例子开始，看看 Snabbdom 做了哪些事情</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">var</span> snabbdom <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'snabbdom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> patch <span class="token operator">=</span> snabbdom<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'snabbdom/modules/class'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">,</span>
  <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'snabbdom/modules/props'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">,</span> 
  <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'snabbdom/modules/style'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">,</span> 
  <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'snabbdom/modules/eventlisteners'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面的代码中，使用 snabbdom 的 init 方法，并返回了一个 patch 方法。init 的参数数组里面包含一系列模块，这些模块其实都是只是简单的 JavaScript 对象，这些模块是由 snabbdom 的生命周期的一些回调函数组成，比如在 class 模块中，其实就是一个 {create:()=&gt;{},update:()=&gt;{}} 这样的一个对象，在元素创建时，会调用 class 模块注册 create 方法，这个时候就可以把 class 加在 dom 上，update 的时候，就可以做移除旧的样式类，并且添加新的样式类。</p> <h4 id="init-方法"><a href="#init-方法" aria-hidden="true" class="header-anchor">#</a> init 方法</h4> <p>init 方法主要做了几件事情</p> <ol><li>收集不同模块生命周期回调函数，并把他们都保存在一个对象中，如 cbs = {create:[...],update:[…]}，在对应操作的时机就会遍历这些生命周期并进行调用</li> <li>初始 DOM 操作 api，dom 操作 API 可以由 init 的第二参数传递进去，也可以使用默认的 html 操作 api，为了浏览器的兼容问题，我们可以自己传递一些写好 dom api，只要实现对应的接口即可</li> <li>定义一些操作 api，其中比较重要的有 patchVnode 方法，用来对比两个虚拟节点，并进行更新，同时也会对子节点进行更新，可以理解为会对一颗子树进行比较更新。patchChildren 用来对于虚拟节点的 children 数组进行对比和更新。</li> <li>定义 patch 方法，并返回 patch 方法。patch 方法主要用来处理传入的参数问题和调用一些生命周期。在上面的辅助方法中，都会在合适的时机去调用对应的生命周期函数</li></ol> <h3 id="init-方法-2"><a href="#init-方法-2" aria-hidden="true" class="header-anchor">#</a> Init 方法</h3> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> hooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'create'</span><span class="token punctuation">,</span> <span class="token string">'update'</span><span class="token punctuation">,</span> <span class="token string">'remove'</span><span class="token punctuation">,</span> <span class="token string">'destroy'</span><span class="token punctuation">,</span> <span class="token string">'pre'</span><span class="token punctuation">,</span> <span class="token string">'post'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">modules<span class="token punctuation">:</span><span class="token builtin">Array</span><span class="token operator">&lt;</span>Patial<span class="token operator">&lt;</span>Module<span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>domApi<span class="token operator">?</span><span class="token punctuation">:</span><span class="token constant">DOMAPI</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> cbs<span class="token punctuation">:</span>ModuleHooks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>lifeCircle <span class="token keyword">of</span> hooks<span class="token punctuation">)</span><span class="token punctuation">{</span>
    cbs<span class="token punctuation">[</span>circle<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">module</span> <span class="token keyword">of</span> modules<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">[</span>lifeCircle<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        cbs<span class="token punctuation">[</span>lifeCircle<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">[</span>lifeCircle<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 生命周期的回调收集，其实就是遍历所有模块，并把他们的回调存储起来,这种方式同样值得我们借鉴</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">oldNode<span class="token punctuation">:</span>Element<span class="token operator">|</span>IVnode<span class="token punctuation">,</span>vnode<span class="token punctuation">:</span>IVNode</span><span class="token punctuation">)</span><span class="token punctuation">:</span>IVNode<span class="token punctuation">{</span>
    <span class="token keyword">const</span> insertedVnodeQueue<span class="token punctuation">:</span>IVNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 定义了一个数据，使用数组存储插入过 VNode，主要用于在 DOM 插入之后，触发 insert 钩子</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>pre <span class="token keyword">of</span> cbs<span class="token punctuation">.</span>pre<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token comment">// 调用 pre 生命周期钩子</span>
    
    <span class="token comment">// 所有 DOM 元素都会挂在 Vnode 的 elm 属性下，如果是一个元素的话，那么就给他一个空 Node</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNode</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      oldNode <span class="token operator">=</span> <span class="token function">emptyNodeAt</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果是相同的节点，那么使用新节点去更新旧节点</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sameNode</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">,</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">patchNode</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">,</span>vnode<span class="token punctuation">,</span>insertedVnodeQueue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token comment">// 如果不是相同节点，那么重建 DOM 树</span>
      <span class="token keyword">const</span> elm <span class="token operator">=</span> oldNode<span class="token punctuation">.</span>elm
      <span class="token function">createElement</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span>insertedVnodeQueue<span class="token punctuation">)</span>
      <span class="token keyword">const</span> parent <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>parent <span class="token operator">!==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span>vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span>api<span class="token punctuation">.</span><span class="token function">nextSiblings</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">)</span>
        api<span class="token punctuation">.</span><span class="token function">removeNodes</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span><span class="token punctuation">[</span>oldNode<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 调用 insert 生命周期钩子</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">of</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">{</span>
      item<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 调用 post 生命周期钩子</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">of</span> cbs<span class="token punctuation">.</span>post<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">item</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="patchvnode-方法"><a href="#patchvnode-方法" aria-hidden="true" class="header-anchor">#</a> patchVnode 方法</h3> <p>patchVnode 方法也比较简单，主要做了以下几个事情</p> <ol><li><p>调用 prepatch 生命周期钩子</p></li> <li><p>调用 update 生命周期钩子</p></li> <li><p>比较更新节点，主要逻辑如下</p> <ol><li><p>新的节点不是一个文本节点的话。</p> <p>如果都定义了子节数组，那么调用 updateChildren 来更新子节点</p> <p>​    如果只定义了 newVnode 的 children，说明为新增子节点，调用 addNodes 方法，把子节点插入，如果存在旧节点定义 text，那么旧节点是一个文本节点，需要把 text 也清除掉</p> <p>​    如果只定义了 oldVNode.chidren 那么说明这种情况为删除节点，调用 removeNodes 把子节点删除</p> <p>​    最后一种情况，就是 oldVNode.children,newVNode.children 都没定义，新节点又不是一个文本节点，那么即是需要删除旧的文本节点了</p></li> <li><p>第二种情况就是新节点是一个文本节点了，比较并更新文本，然后如果 oldVnode 定义了 children 那么把子节点删除</p></li></ol></li> <li><p>调用 postpatch 钩子</p></li></ol> <h3 id="patchchildren"><a href="#patchchildren" aria-hidden="true" class="header-anchor">#</a> patchChildren</h3> <p>patchChildren 方法比较复杂，需要比较两个 vnode 数组之间的差异，并进行合适的更新，首先分别使用两个指针指向旧节点和新节点的首尾，然后使用循环来移动指针，达到去除两个数组首尾为 null 的元素。比较 首首，尾尾，首尾，尾首 元素是否相同，如果是那么使用 patchNode 对这两个元素进行更新，并对指针进行合适的移动。</p> <p>上面的比较主要是处理元素顺序的问题，例如如果只是列表的顺序变为相反的话，那么上面的尾首比较就能识别出来，调用 patchVNode 更新节点，然后使用 insertBefore 把列表最后一个 DOM 元素插到第一个前面就可以了。如果上面比较失败的话，那么就使用 key 取判断旧节点里面是否存在着相同的 key，如果存在的话，进行更新和插入，不存在就创建插入</p> <p>最后通过比较旧节点的首尾指针，和新节点的首尾指针来判断是进行增加节点操作还是删除节点操作</p> <h3 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h3> <p>以上就是 Snabbdom 的一些主要内容，整体逻辑并不难，比较有难度的地方就在 patchChildren 这一块的算法中。Snabbdom 这个库的主要功能就是比较两个 VNode 之间的差异，并对 DOM 进行合适的更新。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ccbd119b.js" defer></script><script src="/assets/js/2.7f0dc0b6.js" defer></script><script src="/assets/js/18.11f598b4.js" defer></script>
  </body>
</html>
